<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalle del producto | StarClutch</title>
  <link rel="stylesheet" href="../styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>

<nav class="sidebar">
  <div class="logo">
    <img src="../img/Logo starclutch web.svg" alt="Logo Starclutch">
  </div>
  <div class="user-info">
    <a href="../perfildeusuario/index.html">
      <span class="nav-icon"><img src="../img/Usuario.svg" alt="Usuario"></span>
      <span class="nav-text">Hola, <strong class="nav-username"></strong></span>
    </a>
  </div>
  <div class="search-general">
    <input type="text" placeholder="B√∫squeda general" class="input-general">
    <button class="btn-search-general">
      <img src="../img/Buscar.svg" alt="Buscar">
    </button>
  </div>
  <ul class="menu main-nav">
    <li>
      <a href="../mis flotas/index.html" class="active" aria-current="page">
        <span class="nav-icon"><img src="../img/Agregar flota.svg" alt="Ver mi flotas"></span>
        <span class="nav-text">Mis flotas</span>
      </a>
    </li>
    <li>
      <a href="../lista de repuestos/index.html">
        <span class="nav-icon"><img src="../img/Productos.svg" alt="Lista de repuestos"></span>
        <span class="nav-text">Lista de repuestos</span>
      </a>
    </li>
    <li>
      <a href="../ofertas exclusivas/index.html">
        <span class="nav-icon"><img src="../img/Descuento.svg" alt="Ofertas"></span>
        <span class="nav-text">Ofertas exclusivas</span>
      </a>
    </li>
    <li>
      <a href="../estado de la cuenta/index.html">
        <span class="nav-icon"><img src="../img/bill-01 1.svg" alt="Estado de cuenta"></span>
        <span class="nav-text">Estado de cuenta</span>
      </a>
    </li>
    <li>
      <a href="../mis compras/index.html.html">
        <span class="nav-icon"><img src="../img/miscompras.svg" alt="Mis compras"></span>
        <span class="nav-text">Mis compras</span>
      </a>
    </li>
  </ul>
  <footer class="sidebar-footer">
    <a href="https://starclutch.cl/repuestos" target="_blank" rel="noopener noreferrer" class="btn-text footer-link">
      <span class="icon-left"><img src="../img/Logo SC.svg" alt="Nosotros"></span> Nosotros
    </a>
    <p>Starclutch S.p.A<br>¬© Todos los derechos reservados 2025</p>
  </footer>
</nav>

<main class="main-content">
  <div class="page-container">
    
    <header class="main-header">
      <div class="header-left"><h1>Embragues</h1></div>
      <div class="header-actions">
        <button class="btn-text"><span class="icon-left"><img src="../img/info_471662-01 1.svg" alt="Ayuda"></span> Ayuda</button>
        <button class="btn-text" onclick="toggleCarrito()" style="position: relative;"><span class="icon-left" style="position: relative; display: inline-flex; align-items: center;"><img src="../img/carrito.svg" alt="Carrito"><span class="cart-badge" id="cart-badge-count">0</span></span> Carrito</button>
        <button class="btn-text" id="btn-notificaciones" onclick="toggleNotificaciones()" style="position: relative;"><span class="icon-left" style="position: relative; display: inline-flex; align-items: center;"><img src="../img/Alerta.svg" alt="Notificaciones"><span class="notif-badge" id="notif-badge-count">0</span></span> Notificaciones</button>
      </div>
    </header>

  <section class="product-detail-container">
        
        <div class="detail-left-column">
            
            <div class="detail-header">
                <h2 class="detail-title">Kit de embrague Scania Serie 5 (2018-2023) Reforzado</h2>
                <span class="detail-sku">SKU: DFVOV200V</span>
            </div>

            <div class="gallery-container">
                
                <div class="main-image-stack">
                    
                    <button class="btn-nav-detalle prev prod-arrow" aria-label="Anterior">‚Äπ</button>

                    <div class="image-carousel-wrapper">
                        <img src="../marcasproductos/VALEO.png" alt="Valeo" class="brand-floating">
                        <img src="../sku/DFDAT1539F.png" alt="Producto Principal" class="main-product-image">
                        <div class="carousel-indicators">
                            <span class="dot active"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </div>
                    </div>

                    <button class="btn-nav-detalle next prod-arrow" aria-label="Siguiente">‚Ä∫</button>
                
                </div>

                <div class="side-thumbs-column">
                    <div class="side-thumb active">
                        <img src="../sku/DFDAT1539F.png" alt="Vista 1">
                    </div>
                    <div class="side-thumb">
                        <img src="https://placehold.co/200x200/png?text=2" alt="Vista 2">
                    </div>
                    <div class="side-thumb">
                        <img src="https://placehold.co/200x200/png?text=3" alt="Vista 3">
                    </div>
                    <div class="side-thumb">
                        <img src="https://placehold.co/200x200/png?text=4" alt="Vista 4">
                    </div>
                </div>

            </div>

            <div class="left-actions-row">
                <div class="qty-group">
                    <span class="qty-label">Cantidad:</span>
                    <div class="quantity-selector">
                        <button type="button" class="qty-btn minus">-</button>
                        <input type="number" value="1" min="1" class="qty-input">
                        <button type="button" class="qty-btn plus">+</button>
                    </div>
                </div>

                <div class="stock-indicator">
                    <strong>Stock:</strong> <span class="dot-stock"></span> Disponible
                </div>
            </div>

        </div>

        <div class="detail-right-column">
            
            <div class="specs-panel">
                <div class="specs-tabs">
                    <button class="tab-btn active">Ficha T√©cnica</button>
                    <button class="tab-btn">Referencia Cruzada</button>
                    <button class="tab-btn">C√≥digos OEM</button>
                </div>

                <div class="specs-body-scroll">
                    <div class="spec-row">
                        <span class="spec-label">Di√°metro exterior</span>
                        <span class="spec-value">430 mm</span>
                    </div>
                    <div class="spec-row">
                        <span class="spec-label">N√∫mero de estr√≠as</span>
                        <span class="spec-value">24</span>
                    </div>
                    <div class="spec-row">
                        <span class="spec-label">Perfil del cubo</span>
                        <span class="spec-value">26x28</span>
                    </div>
                    <div class="spec-row">
                        <span class="spec-label">Par de apriete</span>
                        <span class="spec-value">55 Nm</span>
                    </div>
                    <div class="spec-row">
                        <span class="spec-label">Peso</span>
                        <span class="spec-value">42.5 kg</span>
                    </div>
                    <div class="spec-row">
                        <span class="spec-label">Origen</span>
                        <span class="spec-value">Alemania</span>
                    </div>
                    <div class="spec-row">
                        <span class="spec-label">Garant√≠a</span>
                        <span class="spec-value">1 A√±o</span>
                    </div>
                     <div class="spec-row">
                        <span class="spec-label">Material</span>
                        <span class="spec-value">Acero</span>
                    </div>
                </div>

                <div class="specs-actions-footer">
                    <button class="btn-text btn-descargar-ficha" onclick="descargarFichaTecnica()">
                        <img src="../img/Descargar.svg" alt="Descargar"> Descargar ficha
                    </button>
                    <button class="btn-text" onclick="copiarEspecificaciones()">
                        <img src="../img/Copiar.svg" alt="Copiar"> Copiar
                    </button>
                </div>
            </div>

            <div class="price-buy-block">
                <div class="price-stack">
                    <span class="price-old">$1.500.000</span>
                    <span class="price-final">$1.250.000</span>
                    <span class="iva-text">IVA incluido</span>
                </div>
                
                <button class="btn-secondary btn-buy-final">
                    Agregar al carrito <img src="../img/carritorojo.svg" alt="Carrito">
                </button>
            </div>

        </div>
    </section>

    <section class="seccion-recomendados-detalle">
      
      <h3>Otros productos</h3>

      <div class="carrusel-contenedor-detalle" data-rows="1" data-cols="4">
        
        <button class="btn-nav-detalle prev" aria-label="Anterior">‚Äπ</button>
        
        <div class="viewport-detalle">
          <div class="track-detalle" id="carrusel-track-productos">
            <!-- Tarjetas din√°micas se cargar√°n aqu√≠ -->
          </div>
        </div>

        <button class="btn-nav-detalle next" aria-label="Siguiente">‚Ä∫</button>
        
      </div>
    </section>

  </div>
</main>

<script src="../script.js"></script>
 
<script>
  // Variable global para almacenar el producto actual
  let productoActual = null;
  
  // Funci√≥n para normalizar texto (min√∫sculas, sin acentos, sin espacios m√∫ltiples, sin guiones)
  function normalizarTexto(texto) {
    if (!texto) return '';
    return texto
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "") // Eliminar acentos
      .replace(/[-_]/g, '') // Eliminar guiones y guiones bajos
      .trim()
      .replace(/\s+/g, ' '); // Normalizar espacios
  }

  // ==== SISTEMA DE TRACKING DE INTERACCIONES ====
  function getTrackingKey(vehiculo) {
    try {
      const user = JSON.parse(localStorage.getItem('starclutch_user') || 'null');
      if (user && (user.id || user.email)) {
        return `tracking_user_${user.id || user.email}`;
      }

      let v = vehiculo;
      if (!v) {
        const vehData = sessionStorage.getItem('vehiculo-seleccionado');
        if (vehData) v = JSON.parse(vehData);
      }

      if (v) {
        const parts = [v.marca || '', v.modelo || '', v.motor || '', v.tipo || '']
          .map(s => normalizarTexto(String(s || '')))
          .filter(Boolean);
        const vehKey = parts.join('_') || 'unknown';
        return `tracking_veh_${vehKey}`;
      }

      return 'tracking_global';
    } catch (e) {
      console.error('Error generando tracking key:', e);
      return 'tracking_global';
    }
  }

  function registrarVistaProducto(sku, vehiculo) {
    try {
      const key = getTrackingKey(vehiculo);
      const tracking = JSON.parse(localStorage.getItem(key) || '{"visitas": {}, "carritos": {}}');

      // Registrar visita
      const keySku = normalizarTexto(sku);
      if (!tracking.visitas[keySku]) tracking.visitas[keySku] = 0;
      tracking.visitas[keySku]++;

      localStorage.setItem(key, JSON.stringify(tracking));
      console.log(`Vista registrada: ${sku} (${tracking.visitas[sku]} veces) en ${key}`);
    } catch (error) {
      console.error('Error registrando vista:', error);
    }
  }

  function registrarAgregarCarrito(sku, vehiculo) {
    try {
      const key = getTrackingKey(vehiculo);
      const tracking = JSON.parse(localStorage.getItem(key) || '{"visitas": {}, "carritos": {}}');

      // Registrar agregado al carrito
      const keySku = normalizarTexto(sku);
      if (!tracking.carritos[keySku]) tracking.carritos[keySku] = 0;
      tracking.carritos[keySku]++;

      localStorage.setItem(key, JSON.stringify(tracking));
      console.log(`Carrito registrado: ${sku} (${tracking.carritos[sku]} veces) en ${key}`);
    } catch (error) {
      console.error('Error registrando carrito:', error);
    }
  }

  // Cargar detalle del producto
  document.addEventListener('DOMContentLoaded', async function() {
    // Primero verificar si hay par√°metros en la URL (tienen prioridad m√°xima)
    const urlParams = new URLSearchParams(window.location.search);
    const sku = urlParams.get('sku');
    const idProducto = urlParams.get('id');
    
    // Si hay par√°metros en URL, usarlos (prioridad 1)
    if (sku || idProducto) {
      console.log('Cargando producto desde URL - id:', idProducto, 'sku:', sku);
      
      // Limpiar sessionStorage para evitar conflictos
      sessionStorage.removeItem('productoDetalle');
      
      try {
        // Cargar productos_db.json
        const response = await fetch('../datosproductos/productos_db.json');
        const productos = await response.json();
        
        // Buscar producto por ID primero, luego por SKU (codSC)
        let producto = null;
        if (idProducto) {
          producto = productos.find(p => p.id === idProducto);
          console.log('Buscando por ID:', idProducto, '- Encontrado:', !!producto);
        }
        if (!producto && sku) {
          producto = productos.find(p => normalizarTexto(p.codSC) === normalizarTexto(sku));
          console.log('Buscando por SKU:', sku, '- Encontrado:', !!producto);
        }
        
        if (!producto) {
          console.error('Producto no encontrado:', idProducto || sku);
          mostrarMensajeError();
          return;
        }
        
        // Registrar vista del producto
        try {
          const vehiculoData = sessionStorage.getItem('vehiculo-seleccionado');
          const vehiculo = vehiculoData ? JSON.parse(vehiculoData) : null;
          registrarVistaProducto(producto.codSC, vehiculo);
        } catch (e) {
          console.error('Error al registrar vista:', e);
        }
        
        // Renderizar el producto
        renderizarDetalleProducto(producto);
        return;
        
      } catch (error) {
        console.error('Error cargando producto desde URL:', error);
        mostrarMensajeError();
        return;
      }
    }
    
    // Prioridad 2: Intentar leer de sessionStorage (cuando viene de lista de repuestos sin params)
    const sessionData = sessionStorage.getItem('productoDetalle');
    
    if (sessionData) {
      try {
        const producto = JSON.parse(sessionData);
        console.log('Cargando producto desde sessionStorage:', producto.codSC);
        renderizarDetalleProducto(producto);
        
        // Registrar vista del producto
        try {
          const vehiculoData = sessionStorage.getItem('vehiculo-seleccionado');
          const vehiculo = vehiculoData ? JSON.parse(vehiculoData) : null;
          registrarVistaProducto(producto.codSC, vehiculo);
        } catch (e) {
          console.error('Error al registrar vista (fallback):', e);
          registrarVistaProducto(producto.codSC, null);
        }
        return;
      } catch (e) {
        console.error('Error al parsear sessionStorage:', e);
      }
    }
    
    // No hay datos disponibles
    console.error('No se proporcion√≥ SKU ni ID ni hay datos en sessionStorage');
    mostrarMensajeError();
  });
  
  function renderizarDetalleProducto(producto) {
    // Guardar producto en variable global para uso del generador de PDF
    productoActual = producto;
    
    // Actualizar t√≠tulo y SKU
    const titleElement = document.querySelector('.detail-title');
    const skuElement = document.querySelector('.detail-sku');
    
    if (titleElement) {
      titleElement.textContent = producto.repuesto || 'Producto sin nombre';
    }
    if (skuElement) {
        // Si codCliente es string no vac√≠o y no null/undefined, mostrarlo, si no mostrar codSC
        let codCliente = (typeof producto.codCliente === 'string' && producto.codCliente.trim() !== '') ? producto.codCliente.trim() : '';
        const codSC = producto.codSC || 'N/A';
        if (codCliente) {
          skuElement.innerHTML = `SKU: <span class="sku-visible">${codCliente}</span><span class="sku-invisible" style="display:none;">${codSC}</span>`;
        } else {
          skuElement.textContent = `SKU: ${codSC}`;
        }
    }
    
    // Actualizar header de la p√°gina
    const headerH1 = document.querySelector('.header-left h1');
    if (headerH1) {
      headerH1.textContent = producto.linea || 'Detalle del producto';
    }
    
    // Actualizar logo de marca
    const marcaLogo = document.querySelector('.brand-floating');
    if (marcaLogo && producto.marca) {
      marcaLogo.src = `../marcasproductos/${producto.marca.toUpperCase()}.png`;
      marcaLogo.alt = producto.marca;
      marcaLogo.onerror = function() {
        this.src = '../img/placeholder-logo-marca.svg';
      };
    }
    
    // Actualizar imagen principal y galer√≠a
    if (producto.imagenes && producto.imagenes.length > 0) {
      const mainImage = document.querySelector('.main-product-image');
      if (mainImage) {
        mainImage.src = producto.imagenes[0];
        mainImage.style.display = 'block';
        mainImage.onerror = function() {
          // Si falla la carga, mostrar placeholder personalizado
          this.style.display = 'none';
          const wrapper = this.closest('.image-carousel-wrapper');
          if (wrapper && !wrapper.querySelector('.custom-placeholder')) {
            const placeholder = document.createElement('div');
            placeholder.className = 'custom-placeholder';
            placeholder.style.cssText = 'display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%; background: #f8f9fa; position: absolute; top: 0; left: 0;';
            placeholder.innerHTML = `
              <img src="../img/Logo SC.svg" alt="StarClutch" style="width: 120px; height: 120px; margin-bottom: 16px; opacity: 0.5;">
              <p style="text-align: center; color: #999; font-size: 14px; margin: 0;">No hay imagen para este producto</p>
            `;
            wrapper.appendChild(placeholder);
          }
        };
      }
      
      // Actualizar miniaturas laterales (solo si hay m√°s de 1 imagen)
      const thumbsContainer = document.querySelector('.side-thumbs-column');
      if (thumbsContainer) {
        if (producto.imagenes.length > 1) {
          let thumbsHtml = '';
          producto.imagenes.slice(0, 4).forEach((img, index) => {
            thumbsHtml += `
              <div class="side-thumb ${index === 0 ? 'active' : ''}" onclick="cambiarImagenPrincipal('${img}', this)">
                <img src="${img}" alt="Vista ${index + 1}" onerror="this.src='https://placehold.co/200x200/png?text=${index + 1}'">
              </div>
            `;
          });
          thumbsContainer.innerHTML = thumbsHtml;
          thumbsContainer.style.display = 'flex';
        } else {
          // Solo 1 imagen: ocultar miniaturas
          thumbsContainer.innerHTML = '';
          thumbsContainer.style.display = 'none';
        }
      }
      
      // Actualizar indicadores del carrusel (solo si hay m√°s de 1 imagen)
      const indicators = document.querySelector('.carousel-indicators');
      if (indicators) {
        if (producto.imagenes.length > 1) {
          let indicatorsHtml = '';
          producto.imagenes.slice(0, 4).forEach((img, index) => {
            indicatorsHtml += `<span class="dot ${index === 0 ? 'active' : ''}" onclick="cambiarImagenPrincipal('${img}', null, ${index})"></span>`;
          });
          indicators.innerHTML = indicatorsHtml;
          indicators.style.display = 'flex';
        } else {
          // Solo 1 imagen: ocultar indicadores
          indicators.innerHTML = '';
          indicators.style.display = 'none';
        }
      }
      
      // Botones de navegaci√≥n (ocultar si hay 1 sola imagen)
      const prevBtn = document.querySelector('.prod-arrow.prev');
      const nextBtn = document.querySelector('.prod-arrow.next');
      if (producto.imagenes.length <= 1) {
        if (prevBtn) prevBtn.style.display = 'none';
        if (nextBtn) nextBtn.style.display = 'none';
      } else {
        if (prevBtn) prevBtn.style.display = 'flex';
        if (nextBtn) nextBtn.style.display = 'flex';
      }
      
      // Reinicializar galer√≠a despu√©s de actualizar im√°genes
      setTimeout(() => {
        initGaleriaProducto();
      }, 50);
    } else {
      // No hay im√°genes - mostrar placeholder personalizado
      const mainImage = document.querySelector('.main-product-image');
      const wrapper = document.querySelector('.image-carousel-wrapper');
      
      if (mainImage) {
        mainImage.style.display = 'none';
      }
      
      if (wrapper && !wrapper.querySelector('.custom-placeholder')) {
        const placeholder = document.createElement('div');
        placeholder.className = 'custom-placeholder';
        placeholder.style.cssText = 'display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%; background: #f8f9fa; position: absolute; top: 0; left: 0;';
        placeholder.innerHTML = `
          <img src="../img/Logo SC.svg" alt="StarClutch" style="width: 120px; height: 120px; margin-bottom: 16px; opacity: 0.5;">
          <p style="text-align: center; color: #999; font-size: 14px; margin: 0;">No hay imagen para este producto</p>
        `;
        wrapper.appendChild(placeholder);
      }
      
      // Ocultar miniaturas e indicadores
      const thumbsContainer = document.querySelector('.side-thumbs-column');
      if (thumbsContainer) {
        thumbsContainer.innerHTML = '';
      }
      
      const indicators = document.querySelector('.carousel-indicators');
      if (indicators) {
        indicators.innerHTML = '';
      }
      
      // Ocultar botones de navegaci√≥n
      const prevBtn = document.querySelector('.btn-nav-detalle.prev');
      const nextBtn = document.querySelector('.btn-nav-detalle.next');
      if (prevBtn) prevBtn.style.display = 'none';
      if (nextBtn) nextBtn.style.display = 'none';
    }
    
    // Actualizar ficha t√©cnica
    const specsBody = document.querySelector('.specs-body-scroll');
    if (specsBody) {
      let specsHtml = '';
      if (producto.fichaTecnica) {
        // Parsear la ficha t√©cnica (asumiendo formato "Campo: Valor")
        const lineas = producto.fichaTecnica.split('\n');
        lineas.forEach(linea => {
          const partes = linea.split(':');
          if (partes.length >= 2) {
            specsHtml += `
              <div class="spec-row">
                <span class="spec-label">${partes[0].trim()}</span>
                <span class="spec-value">${partes.slice(1).join(':').trim()}</span>
              </div>
            `;
          } else if (linea.trim()) {
            specsHtml += `
              <div class="spec-row">
                <span class="spec-label">Informaci√≥n</span>
                <span class="spec-value">${linea.trim()}</span>
              </div>
            `;
          }
        });
      }
      specsBody.innerHTML = specsHtml || '<p style="padding: 20px; text-align: center; color: #666;">No hay ficha t√©cnica disponible</p>';
    }
    
    // Actualizar tabs de especificaciones
    configurarTabs(producto);
    
    // Actualizar stock
    const stockIndicator = document.querySelector('.stock-indicator');
    const qtyInput = document.querySelector('.qty-input');
    const stock = producto.stock || 0;
    
    if (stockIndicator) {
      if (stock > 0) {
        stockIndicator.innerHTML = `<strong>Stock:</strong> <span class="dot-stock" style="background: #28a745;"></span> ${stock} unidad${stock !== 1 ? 'es' : ''} disponible${stock !== 1 ? 's' : ''}`;
      } else {
        stockIndicator.innerHTML = '<strong>Stock:</strong> <span class="dot-stock" style="background: #dc3545;"></span> No disponible';
      }
    }
    
    // Configurar l√≠mite m√°ximo de cantidad seg√∫n stock
    if (qtyInput) {
      qtyInput.setAttribute('data-max-stock', stock);
      qtyInput.max = stock;
      
      const minusBtn = document.querySelector('.qty-btn.minus');
      const plusBtn = document.querySelector('.qty-btn.plus');
      
      if (stock === 0) {
        qtyInput.value = 0;
        qtyInput.disabled = true;
        // Deshabilitar botones visualmente
        if (minusBtn) {
          minusBtn.disabled = true;
          minusBtn.style.opacity = '0.5';
          minusBtn.style.cursor = 'not-allowed';
        }
        if (plusBtn) {
          plusBtn.disabled = true;
          plusBtn.style.opacity = '0.5';
          plusBtn.style.cursor = 'not-allowed';
        }
      } else {
        qtyInput.value = 1;
        qtyInput.disabled = false;
        // Habilitar botones visualmente
        if (minusBtn) {
          minusBtn.disabled = false;
          minusBtn.style.opacity = '1';
          minusBtn.style.cursor = 'pointer';
        }
        if (plusBtn) {
          plusBtn.disabled = false;
          plusBtn.style.opacity = '1';
          plusBtn.style.cursor = 'pointer';
        }
        
        // Configurar funcionalidad de mantener presionado para incremento/decremento r√°pido
        configurarBotonesMantenidos(minusBtn, plusBtn, qtyInput, stock);
      }
    }
    
    // Actualizar precios
    const tieneDescuento = producto.descuento && producto.descuento > 0;
    const precioOriginal = producto.precio;
    const precioFinal = tieneDescuento ? (producto.precio * (1 - producto.descuento / 100)) : producto.precio;
    
    const priceStack = document.querySelector('.price-stack');
    if (priceStack) {
      let priceHtml = '';
      if (tieneDescuento) {
        priceHtml += `<span class="price-old">$${Math.round(precioOriginal).toLocaleString('es-CL')}</span>`;
      }
      priceHtml += `<span class="price-final">$${Math.round(precioFinal).toLocaleString('es-CL')}</span>`;
      priceHtml += `<span class="iva-text">IVA incluido</span>`;
      priceStack.innerHTML = priceHtml;
    }
    
    // Configurar bot√≥n de agregar al carrito
    const btnBuy = document.querySelector('.btn-buy-final');
    if (btnBuy) {
      btnBuy.onclick = () => agregarAlCarrito(producto.codSC);
    }
  }
  
  function configurarTabs(producto) {
    const tabs = document.querySelectorAll('.tab-btn');
    const specsBody = document.querySelector('.specs-body-scroll');
    
    if (!tabs.length || !specsBody) return;
    
    tabs.forEach((tab, index) => {
      tab.onclick = () => {
        // Remover active de todos
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Cambiar contenido seg√∫n tab
        if (index === 0) {
          // Ficha T√©cnica
          let specsHtml = '';
          if (producto.fichaTecnica) {
            const lineas = producto.fichaTecnica.split('\n');
            lineas.forEach(linea => {
              const partes = linea.split(':');
              if (partes.length >= 2) {
                specsHtml += `
                  <div class="spec-row">
                    <span class="spec-label">${partes[0].trim()}</span>
                    <span class="spec-value">${partes.slice(1).join(':').trim()}</span>
                  </div>
                `;
              } else if (linea.trim()) {
                specsHtml += `
                  <div class="spec-row">
                    <span class="spec-label">Informaci√≥n</span>
                    <span class="spec-value">${linea.trim()}</span>
                  </div>
                `;
              }
            });
          }
          specsBody.innerHTML = specsHtml || '<p style="padding: 20px; text-align: center; color: #666;">No hay ficha t√©cnica disponible</p>';
        } else if (index === 1) {
          // Referencia Cruzada
          let refHtml = '';
          if (producto.referenciaCruzada) {
            const lineas = producto.referenciaCruzada.split('\n');
            lineas.forEach(linea => {
              if (linea.trim()) {
                const partes = linea.split(':');
                if (partes.length >= 2) {
                  refHtml += `
                    <div class="spec-row">
                      <span class="spec-label">${partes[0].trim()}</span>
                      <span class="spec-value">${partes.slice(1).join(':').trim()}</span>
                    </div>
                  `;
                } else {
                  refHtml += `
                    <div class="spec-row">
                      <span class="spec-label">Referencia</span>
                      <span class="spec-value">${linea.trim()}</span>
                    </div>
                  `;
                }
              }
            });
          }
          specsBody.innerHTML = refHtml || '<p style="padding: 20px; text-align: center; color: #666;">No hay referencias cruzadas disponibles</p>';
        } else if (index === 2) {
          // C√≥digos OEM
          let oemHtml = '';
          if (producto.oem) {
            const lineas = producto.oem.split('\n');
            lineas.forEach(linea => {
              if (linea.trim()) {
                const partes = linea.split(':');
                if (partes.length >= 2) {
                  oemHtml += `
                    <div class="spec-row">
                      <span class="spec-label">${partes[0].trim()}</span>
                      <span class="spec-value">${partes.slice(1).join(':').trim()}</span>
                    </div>
                  `;
                } else {
                  oemHtml += `
                    <div class="spec-row">
                      <span class="spec-label">C√≥digo OEM</span>
                      <span class="spec-value">${linea.trim()}</span>
                    </div>
                  `;
                }
              }
            });
          }
          specsBody.innerHTML = oemHtml || '<p style="padding: 20px; text-align: center; color: #666;">No hay c√≥digos OEM disponibles</p>';
        }
      };
    });
  }
  
  // Variable para evitar m√∫ltiples configuraciones de botones
  let botonesConfigurados = false;
  
  // Funci√≥n para configurar incremento r√°pido al mantener presionado
  function configurarBotonesMantenidos(minusBtn, plusBtn, qtyInput, maxStock) {
    // Evitar configurar m√∫ltiples veces (listeners duplicados)
    if (botonesConfigurados) {
      // Solo actualizar el maxStock
      qtyInput.setAttribute('data-max-stock', maxStock);
      return;
    }
    botonesConfigurados = true;
    
    let intervalId = null;
    let timeoutId = null;
    let fueHoldLargo = false;
    const DELAY_INICIAL = 500; // ms antes de empezar incremento r√°pido
    const INTERVALO_RAPIDO = 100; // ms entre cada incremento
    
    function getMaxStock() {
      return parseInt(qtyInput.getAttribute('data-max-stock')) || maxStock;
    }
    
    function incrementar() {
      const current = parseInt(qtyInput.value) || 0;
      const max = getMaxStock();
      if (current < max) {
        qtyInput.value = current + 1;
      }
    }
    
    function decrementar() {
      const current = parseInt(qtyInput.value) || 0;
      if (current > 1) {
        qtyInput.value = current - 1;
      }
    }
    
    function detenerAccion() {
      if (timeoutId) {
        clearTimeout(timeoutId);
        timeoutId = null;
      }
      if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
      }
    }
    
    // Bot√≥n PLUS (+)
    if (plusBtn) {
      plusBtn.addEventListener('mousedown', (e) => {
        e.preventDefault();
        fueHoldLargo = false;
        timeoutId = setTimeout(() => {
          fueHoldLargo = true;
          timeoutId = null;
          intervalId = setInterval(incrementar, INTERVALO_RAPIDO);
        }, DELAY_INICIAL);
      });
      
      plusBtn.addEventListener('mouseup', (e) => {
        // Si NO fue hold largo, incrementar una vez
        if (!fueHoldLargo) {
          incrementar();
        }
        fueHoldLargo = false;
        detenerAccion();
      });
      
      plusBtn.addEventListener('mouseleave', detenerAccion);
      
      // Soporte t√°ctil
      plusBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        fueHoldLargo = false;
        timeoutId = setTimeout(() => {
          fueHoldLargo = true;
          timeoutId = null;
          intervalId = setInterval(incrementar, INTERVALO_RAPIDO);
        }, DELAY_INICIAL);
      }, { passive: false });
      
      plusBtn.addEventListener('touchend', (e) => {
        e.preventDefault();
        if (!fueHoldLargo) {
          incrementar();
        }
        fueHoldLargo = false;
        detenerAccion();
      });
      
      plusBtn.addEventListener('touchcancel', () => {
        fueHoldLargo = false;
        detenerAccion();
      });
    }
    
    // Bot√≥n MINUS (-)
    if (minusBtn) {
      minusBtn.addEventListener('mousedown', (e) => {
        e.preventDefault();
        fueHoldLargo = false;
        timeoutId = setTimeout(() => {
          fueHoldLargo = true;
          timeoutId = null;
          intervalId = setInterval(decrementar, INTERVALO_RAPIDO);
        }, DELAY_INICIAL);
      });
      
      minusBtn.addEventListener('mouseup', (e) => {
        // Si NO fue hold largo, decrementar una vez
        if (!fueHoldLargo) {
          decrementar();
        }
        fueHoldLargo = false;
        detenerAccion();
      });
      
      minusBtn.addEventListener('mouseleave', detenerAccion);
      
      // Soporte t√°ctil
      minusBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        fueHoldLargo = false;
        timeoutId = setTimeout(() => {
          fueHoldLargo = true;
          timeoutId = null;
          intervalId = setInterval(decrementar, INTERVALO_RAPIDO);
        }, DELAY_INICIAL);
      }, { passive: false });
      
      minusBtn.addEventListener('touchend', (e) => {
        e.preventDefault();
        if (!fueHoldLargo) {
          decrementar();
        }
        fueHoldLargo = false;
        detenerAccion();
      });
      
      minusBtn.addEventListener('touchcancel', () => {
        fueHoldLargo = false;
        detenerAccion();
      });
    }
    
    // Validar input manual
    qtyInput.addEventListener('change', () => {
      const max = getMaxStock();
      let val = parseInt(qtyInput.value) || 1;
      if (val < 1) val = 1;
      if (val > max) val = max;
      qtyInput.value = val;
    });
  }
  
  function cambiarImagenPrincipal(imagenSrc, thumbElement, dotIndex) {
    const mainImage = document.querySelector('.main-product-image');
    if (mainImage) {
      mainImage.src = imagenSrc;
    }
    
    // Actualizar estado activo de miniaturas
    if (thumbElement) {
      document.querySelectorAll('.side-thumb').forEach(t => t.classList.remove('active'));
      thumbElement.classList.add('active');
    }
    
    // Actualizar indicadores
    if (typeof dotIndex === 'number') {
      document.querySelectorAll('.carousel-indicators .dot').forEach((dot, i) => {
        if (i === dotIndex) {
          dot.classList.add('active');
        } else {
          dot.classList.remove('active');
        }
      });
    }
  }
  
  // Inicializar carrusel de im√°genes del producto
  let currentImageIndex = 0;
  let productImages = [];
  
  function initGaleriaProducto() {
    // Obtener todas las im√°genes del producto
    const mainImage = document.querySelector('.main-product-image');
    const thumbs = document.querySelectorAll('.side-thumb img');
    
    productImages = Array.from(thumbs).map(thumb => thumb.src);
    
    if (productImages.length === 0 && mainImage && mainImage.src) {
      productImages = [mainImage.src];
    }
    
    // Botones de navegaci√≥n de la galer√≠a principal
    const prevBtn = document.querySelector('.prod-arrow.prev');
    const nextBtn = document.querySelector('.prod-arrow.next');
    
    if (prevBtn && nextBtn) {
      prevBtn.onclick = () => navegarGaleriaProducto(-1);
      nextBtn.onclick = () => navegarGaleriaProducto(1);
      
      // Mostrar/ocultar botones seg√∫n cantidad de im√°genes
      if (productImages.length <= 1) {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
      } else {
        prevBtn.style.display = 'flex';
        nextBtn.style.display = 'flex';
      }
    }
  }
  
  function navegarGaleriaProducto(direccion) {
    if (productImages.length <= 1) return;
    
    currentImageIndex += direccion;
    
    // Loop circular
    if (currentImageIndex < 0) {
      currentImageIndex = productImages.length - 1;
    } else if (currentImageIndex >= productImages.length) {
      currentImageIndex = 0;
    }
    
    cambiarImagenPrincipal(productImages[currentImageIndex], null, currentImageIndex);
  }
  
  // La funci√≥n agregarAlCarrito est√° en script.js (CarritoGlobal)
  
  function mostrarMensajeError() {
    const container = document.querySelector('.product-detail-container');
    if (container) {
      container.innerHTML = `
        <div style="text-align: center; padding: 60px 20px; color: #ff4444;">
          <h3 style="margin: 0 0 10px 0; font-size: 24px;">Producto no encontrado</h3>
          <p style="margin: 0; font-size: 16px;">El producto solicitado no est√° disponible.</p>
          <a href="index.html" class="btn-primary" style="margin-top: 20px; display: inline-block;">Volver a mis flotas</a>
        </div>
      `;
    }
  }
  
  // Inicializar carruseles cuando el DOM est√© listo
  document.addEventListener('DOMContentLoaded', () => {
    // ======================================================
    // INICIALIZAR CARRUSEL DIN√ÅMICO DE OTROS PRODUCTOS
    // ======================================================
    initCarruselOtrosProductos();
    
    // ======================================================
    // INICIALIZAR GALER√çA DE IM√ÅGENES DEL PRODUCTO
    // ======================================================
    // Esperar un momento para que se carguen las im√°genes desde el producto
    setTimeout(() => {
      initGaleriaProducto();
    }, 100);
  });

  // CARRUSEL DIN√ÅMICO
  let productosCarrusel = [];
  let paginaCarruselActual = 0;
  const TARJETAS_POR_PAGINA = 4;

  async function initCarruselOtrosProductos() {
    try {
      const productosData = sessionStorage.getItem('productosCarrusel');
      const origenData = sessionStorage.getItem('origenCarrusel');
      
      console.log('üé™ Inicializando carrusel de Otros Productos');
      console.log('   - productosData existe:', !!productosData);
      console.log('   - origen:', origenData);
      
      if (!productosData) {
        console.warn('‚ö†Ô∏è No hay productos para el carrusel');
        return;
      }
      
      // Obtener SKU del producto actual para excluirlo del carrusel
      let skuActual = null;
      const urlParams = new URLSearchParams(window.location.search);
      skuActual = urlParams.get('sku');
      
      // Si no est√° en URL, intentar obtenerlo de sessionStorage
      if (!skuActual) {
        const productoActualData = sessionStorage.getItem('productoDetalle');
        if (productoActualData) {
          try {
            const productoActual = JSON.parse(productoActualData);
            skuActual = productoActual.codSC;
          } catch (e) {
            console.error('Error parseando producto actual:', e);
          }
        }
      }
      
      console.log('üîç SKU del producto actual:', skuActual);
      
      productosCarrusel = JSON.parse(productosData);
      
      // Obtener usuario y recargar productos desde servidor para tener descuentos actualizados
      let userId = null;
      try {
        const currentUser = JSON.parse(localStorage.getItem('starclutch_user') || 'null');
        if (currentUser && currentUser.id) userId = currentUser.id;
      } catch (e) { console.warn('No hay usuario logueado'); }
      
      if (userId) {
        try {
          const resp = await fetch(`/api/obtener-productos?userId=${userId}`);
          const productosActualizados = await resp.json();
          
          // Crear map de SKU -> producto actualizado para merge r√°pido
          const mapActualizado = {};
          productosActualizados.forEach(p => {
            const key = normalizarTexto(p.codSC || '');
            if (key) mapActualizado[key] = p;
          });
          
          // Actualizar descuentos en productosCarrusel
          productosCarrusel = productosCarrusel.map(p => {
            const key = normalizarTexto(p.codSC || '');
            if (mapActualizado[key]) {
              // Mantener producto original pero actualizar precio y descuento
              return {
                ...p,
                precio: mapActualizado[key].precio,
                descuento: mapActualizado[key].descuento
              };
            }
            return p;
          });
          
          console.log('‚úÖ Descuentos actualizados desde servidor');
        } catch (e) {
          console.warn('No se pudieron actualizar descuentos desde servidor', e);
        }
      }
      
      // Filtrar el producto actual del carrusel
      if (skuActual) {
        const skuActualNorm = normalizarTexto(skuActual);
        const cantidadAntes = productosCarrusel.length;
        productosCarrusel = productosCarrusel.filter(p => 
          normalizarTexto(p.codSC) !== skuActualNorm
        );
        const cantidadDespues = productosCarrusel.length;
        console.log(`üö´ Producto actual excluido del carrusel (${cantidadAntes} ‚Üí ${cantidadDespues})`);
      }
      
      const origen = origenData || 'desconocido';
      
      console.log(`‚úÖ Carrusel cargado: ${productosCarrusel.length} productos desde origen "${origen}"`);
      console.log('   Primeros 3 productos:', productosCarrusel.slice(0, 3).map(p => p.repuesto));
      
      if (productosCarrusel.length === 0) {
        ocultarCarrusel();
        return;
      }
      
      // ==== TRACKING DE INTERACCIONES ====
      function getTrackingKey() {
        try {
          const user = JSON.parse(localStorage.getItem('starclutch_user') || 'null');
          if (user && (user.id || user.email)) return `tracking_user_${user.id || user.email}`;

          const vehData = sessionStorage.getItem('vehiculo-seleccionado');
          if (vehData) {
            const v = JSON.parse(vehData);
            const parts = [v.marca || '', v.modelo || '', v.motor || '', v.tipo || '']
              .map(s => normalizarTexto(String(s || '')))
              .filter(Boolean);
            const vehKey = parts.join('_') || 'unknown';
            return `tracking_veh_${vehKey}`;
          }
          return 'tracking_global';
        } catch (e) {
          console.error('Error generando tracking key:', e);
          return 'tracking_global';
        }
      }

      const trackingKey = getTrackingKey();
      const tracking = JSON.parse(localStorage.getItem(trackingKey) || '{"visitas": {}, "carritos": {}}');
      
      // Calcular score de interacci√≥n para cada producto
      productosCarrusel = productosCarrusel.map(p => {
        const keySku = normalizarTexto(p.codSC || '');
        const visitas = tracking.visitas[keySku] || 0;
        const carritos = tracking.carritos[keySku] || 0;
        const score = (carritos * 10) + visitas;
        
        return { ...p, interactionScore: score };
      });
      
      // ==== ORDENAMIENTO INTELIGENTE ====
      // Extraer base del SKU actual (sin prefijo de marca)
      const baseSkuActual = skuActual ? skuActual.replace(/^[A-Z]+/, '') : '';
      
      productosCarrusel.sort((a, b) => {
        // PRIORIDAD 1: Productos en descuento
        const aDescuento = a.descuento && parseFloat(a.descuento) > 0;
        const bDescuento = b.descuento && parseFloat(b.descuento) > 0;
        if (aDescuento && !bDescuento) return -1;
        if (!aDescuento && bDescuento) return 1;
        
        // PRIORIDAD 2: Coincidencia de nombre/SKU (ej: KITTOY3400DR ‚Üí PASTTOY3400DR, DFTTOY3400DR)
        const baseSKU_A = (a.codSC || '').replace(/^[A-Z]+/, '');
        const baseSKU_B = (b.codSC || '').replace(/^[A-Z]+/, '');
        const aCoincide = baseSkuActual && baseSKU_A === baseSkuActual && baseSKU_A.length > 0;
        const bCoincide = baseSkuActual && baseSKU_B === baseSkuActual && baseSKU_B.length > 0;
        if (aCoincide && !bCoincide) return -1;
        if (!aCoincide && bCoincide) return 1;
        
        // PRIORIDAD 3: Productos m√°s visitados/agregados al carrito
        if (a.interactionScore > 0 && b.interactionScore === 0) return -1;
        if (a.interactionScore === 0 && b.interactionScore > 0) return 1;
        if (a.interactionScore > 0 && b.interactionScore > 0) {
          return b.interactionScore - a.interactionScore;
        }
        
        // PRIORIDAD 4: Resto - mezclar por precio con factor aleatorio
        const precioA = a.precio || 0;
        const precioB = b.precio || 0;
        const rangoA = Math.floor(precioA / 50000);
        const rangoB = Math.floor(precioB / 50000);
        
        if (rangoA !== rangoB) return rangoB - rangoA;
        
        // Dentro del mismo rango, mezclar usando hash del SKU
        const hashA = (a.codSC || '').split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
        const hashB = (b.codSC || '').split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
        return hashA - hashB;
      });
      
      // Renderizar primera p√°gina del carrusel
      renderizarPaginaCarrusel(0);
      
      // Configurar botones prev/next del carrusel de recomendados
      const prevBtn = document.querySelector('.seccion-recomendados-detalle .btn-nav-detalle.prev');
      const nextBtn = document.querySelector('.seccion-recomendados-detalle .btn-nav-detalle.next');
      
      if (prevBtn && nextBtn) {
        // Remover listeners anteriores si existen
        prevBtn.replaceWith(prevBtn.cloneNode(true));
        nextBtn.replaceWith(nextBtn.cloneNode(true));
        
        // Obtener referencias nuevas despu√©s del reemplazo
        const newPrevBtn = document.querySelector('.seccion-recomendados-detalle .btn-nav-detalle.prev');
        const newNextBtn = document.querySelector('.seccion-recomendados-detalle .btn-nav-detalle.next');
        
        if (newPrevBtn) newPrevBtn.onclick = () => navegarCarrusel(-1);
        if (newNextBtn) newNextBtn.onclick = () => navegarCarrusel(1);
      }
      
    } catch (error) {
      console.error('Error inicializando carrusel:', error);
      ocultarCarrusel();
    }
  }

  function renderizarPaginaCarrusel(pagina) {
    const track = document.getElementById('carrusel-track-productos');
    if (!track) return;
    
    track.innerHTML = '';
    
    const inicio = pagina * TARJETAS_POR_PAGINA;
    const fin = inicio + TARJETAS_POR_PAGINA;
    const tarjetas = productosCarrusel.slice(inicio, fin);
    
    tarjetas.forEach(producto => {
      const tieneDescuento = producto.descuento && producto.descuento > 0;
      const precioOriginal = producto.precio || 0;
      const precioFinal = tieneDescuento ? (precioOriginal * (1 - producto.descuento / 100)) : precioOriginal;
      
      const marca = (producto.marca || '').toUpperCase();
      const marcaLogo = `../marcasproductos/${marca}.png`;
      const tieneImagen = producto.imagenes && producto.imagenes.length > 0;
      const primeraImagen = tieneImagen ? producto.imagenes[0] : null;
      
      // Determinar qu√© SKU mostrar
      const codCliente = producto.codCliente || '';
      const codSC = producto.codSC || '';
      const skuVisible = codCliente ? codCliente : codSC;
      const skuInvisible = codCliente ? codSC : '';
      
      const card = document.createElement('div');
      card.className = 'card-producto-detalle';
      card.style.cursor = 'pointer';
      
      card.innerHTML = `
        <div class="header-producto-detalle">
          <h4>${producto.repuesto || 'Producto sin nombre'}</h4>
          <span class="sku-visible">SKU: ${skuVisible}</span>
          ${skuInvisible ? `<span class="sku-invisible">${skuInvisible}</span>` : ''}
          ${tieneDescuento ? '<span class="badge-oferta">Oferta</span>' : ''}
        </div>
        <div class="body-producto-detalle" data-sku="${codSC}">
          ${tieneImagen ? `<img src="${primeraImagen}" alt="${producto.repuesto}" class="carousel-image">` : `<div class="placeholder-sin-imagen"><img src="../img/Logo SC.svg" alt="StarClutch"><p>No hay imagen</p></div>`}
        </div>
        <div class="footer-producto-detalle">
          <div class="logo-marca-detalle">
            <img src="${marcaLogo}" alt="${marca}" onerror="this.src='../img/placeholder-logo-marca.svg'">
          </div>
          <div class="precio-container-detalle">
            ${tieneDescuento ? `<span class="precio-anterior-detalle">$${Math.round(precioOriginal).toLocaleString('es-CL')}</span>` : ''}
            <span class="precio-actual-detalle">$${Math.round(precioFinal).toLocaleString('es-CL')}</span>
          </div>
        </div>
      `;
      
      // Click en tarjeta: ir a detalle del producto
      card.addEventListener('click', () => {
        sessionStorage.setItem('productoDetalle', JSON.stringify({
          ...producto,
          fichaTecnica: producto.fichaTecnica || '',
          referenciaCruzada: producto.referenciaCruzada || '',
          oem: producto.oem || '',
          stock: producto.stock || 0
        }));
        window.location.href = `detalleproducto.html?sku=${encodeURIComponent(producto.codSC)}`;
      });
      
      track.appendChild(card);
    });
    
    paginaCarruselActual = pagina;
    actualizarBotonesCarrusel();
  }

  function navegarCarrusel(direccion) {
    const totalPaginas = Math.ceil(productosCarrusel.length / TARJETAS_POR_PAGINA);
    let nuevaPagina = paginaCarruselActual + direccion;
    
    if (nuevaPagina < 0) nuevaPagina = 0;
    if (nuevaPagina >= totalPaginas) nuevaPagina = totalPaginas - 1;
    
    renderizarPaginaCarrusel(nuevaPagina);
  }

  function actualizarBotonesCarrusel() {
    const totalPaginas = Math.ceil(productosCarrusel.length / TARJETAS_POR_PAGINA);
    const prevBtn = document.querySelector('.seccion-recomendados-detalle .btn-nav-detalle.prev');
    const nextBtn = document.querySelector('.seccion-recomendados-detalle .btn-nav-detalle.next');
    
    if (prevBtn) prevBtn.disabled = paginaCarruselActual === 0;
    if (nextBtn) nextBtn.disabled = paginaCarruselActual >= totalPaginas - 1;
  }

  function ocultarCarrusel() {
    const seccion = document.querySelector('.seccion-recomendados-detalle');
    if (seccion) seccion.style.display = 'none';
  }
  
  // ========== FUNCI√ìN PARA DESCARGAR FICHA T√âCNICA PDF ==========
  async function descargarFichaTecnica() {
    if (!productoActual) {
      console.error('No hay producto cargado para generar la ficha t√©cnica');
      alert('No se pudo cargar la informaci√≥n del producto. Por favor, recarga la p√°gina.');
      return;
    }
    
    // Verificar que el generador de PDF est√© disponible
    if (typeof generarFichaTecnicaPDF !== 'function') {
      console.error('El generador de PDF no est√° disponible');
      alert('Error: El sistema de generaci√≥n de PDF no est√° disponible. Por favor, recarga la p√°gina.');
      return;
    }
    
    // Generar y descargar el PDF
    await generarFichaTecnicaPDF(productoActual);
  }
  
  // ========== FUNCI√ìN PARA COPIAR ESPECIFICACIONES ==========
  function copiarEspecificaciones() {
    if (!productoActual) {
      alert('No hay especificaciones para copiar');
      return;
    }
    
    let texto = `FICHA T√âCNICA - ${productoActual.repuesto || 'Producto'}\n`;
    texto += `C√≥digo StarClutch: ${productoActual.codSC || 'N/A'}\n`;
    texto += `Marca: ${productoActual.marca || 'N/A'}\n`;
    texto += `L√≠nea: ${productoActual.linea || 'N/A'}\n\n`;
    
    if (productoActual.fichaTecnica) {
      texto += `DATOS T√âCNICOS:\n${productoActual.fichaTecnica}\n\n`;
    }
    
    if (productoActual.oem) {
      texto += `C√ìDIGOS OEM:\n${productoActual.oem}\n\n`;
    }
    
    if (productoActual.referenciaCruzada) {
      texto += `REFERENCIA CRUZADA:\n${productoActual.referenciaCruzada}\n`;
    }
    
    navigator.clipboard.writeText(texto).then(() => {
      // Mostrar feedback visual
      const btn = document.querySelector('.specs-actions-footer .btn-text:last-child');
      if (btn) {
        const originalText = btn.innerHTML;
        btn.innerHTML = '<img src="../img/Copiar.svg" alt="Copiado"> ¬°Copiado!';
        btn.style.color = '#28a745';
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.style.color = '';
        }, 2000);
      }
    }).catch(err => {
      console.error('Error al copiar:', err);
      alert('No se pudo copiar al portapapeles');
    });
  }
</script>

<!-- Panel de Carrito -->
<div class="cart-overlay" id="cart-overlay" onclick="cerrarCarrito()"></div>
<div class="cart-panel" id="cart-panel">
  <div class="cart-header">
    <h3><img src="../img/carrito.svg" alt="" style="width:20px;height:20px;filter:brightness(0) invert(1);margin-right:8px;">Carrito</h3>
    <button class="cart-close" onclick="cerrarCarrito()">&times;</button>
  </div>
  <div class="cart-body">
    <div class="cart-empty" id="cart-empty">
      <img src="../img/carrito.svg" alt="Carrito vac√≠o" />
      <p>Tu carrito est√° vac√≠o</p>
    </div>
    <ul class="cart-list" id="cart-list"></ul>
  </div>
  <div class="cart-footer" id="cart-footer" style="display:none;">
    <p class="cart-total"><strong>Total:</strong> $0 <span>IVA incluido</span></p>
    <div class="cart-actions">
      <button class="cart-btn-primary" onclick="generarOrdenCompraDesdeOtroHTML()">Generar OC</button>
      <button class="cart-btn-secondary" onclick="cotizarDesdeOtroHTML()">Cotizar</button>
    </div>
    <a href="carrito.html" class="cart-link">Ver resumen del carrito</a>
  </div>
</div>

<!-- Panel de Notificaciones -->
<div class="notif-overlay" id="notif-overlay" onclick="cerrarNotificaciones()"></div>
<div class="notif-panel" id="notif-panel">
  <div class="notif-header">
    <h3>
      Todas las notificaciones
      <button class="notif-close" onclick="cerrarNotificaciones()">&times;</button>
    </h3>
  </div>
  
  <div class="notif-tabs">
    <div class="notif-tabs-left">
      <button class="notif-tab active" data-filter="todas">Todas</button>
      <button class="notif-tab" data-filter="sin-leer">Sin leer <span class="notif-tab-count"></span></button>
    </div>
    <button id="marcar-todas-vistas">Marcar como vistas</button>
  </div>
  <div class="notif-body">
    <div id="notif-list" style="display: none;"></div>
    <div class="notif-empty" id="notif-empty">
      <div class="notif-empty-icon">
        <img src="../img/Alerta.svg" alt="Sin notificaciones">
      </div>
      <h4>No hay notificaciones</h4>
      <p>Cuando tengas novedades sobre productos, ofertas o actualizaciones, aparecer√°n aqu√≠.</p>
    </div>
  </div>
</div>
 
<script>
function toggleNotificaciones() {
  const panel = document.getElementById('notif-panel');
  const overlay = document.getElementById('notif-overlay');
  if (panel.classList.contains('open')) { cerrarNotificaciones(); }
  else { panel.classList.add('open'); overlay.classList.add('visible'); document.body.style.overflow = 'hidden'; }
}
function cerrarNotificaciones() {
  const panel = document.getElementById('notif-panel');
  const overlay = document.getElementById('notif-overlay');
  panel.classList.remove('open'); overlay.classList.remove('visible'); document.body.style.overflow = '';
}
document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { const panel = document.getElementById('notif-panel'); if (panel && panel.classList.contains('open')) cerrarNotificaciones(); const cartPanel = document.getElementById('cart-panel'); if (cartPanel && cartPanel.classList.contains('open')) cerrarCarrito(); } });
async function toggleCarrito() { const panel = document.getElementById('cart-panel'); const overlay = document.getElementById('cart-overlay'); if (panel.classList.contains('open')) { cerrarCarrito(); } else { if (typeof CarritoGlobal !== 'undefined') { await CarritoGlobal.sincronizar(); CarritoGlobal.iniciarPolling(); } panel.classList.add('open'); overlay.classList.add('visible'); document.body.style.overflow = 'hidden'; } }
function cerrarCarrito() { if (typeof CarritoGlobal !== 'undefined') CarritoGlobal.detenerPolling(); const panel = document.getElementById('cart-panel'); const overlay = document.getElementById('cart-overlay'); panel.classList.remove('open'); overlay.classList.remove('visible'); document.body.style.overflow = ''; }
</script>
</body>
</html>